<section class="w-full pb-20 pt-8 bg-gray-50">
   <div class="container mx-auto px-4 max-w-5xl">
      <div
         class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden"
      >
         <div
            class="p-6 md:p-8 border-b border-gray-100 flex flex-col md:flex-row md:items-center justify-between gap-6"
         >
            <div>
               <h2 class="text-md md:text-2xl font-bold text-gray-900">
                  Avaliações de Clientes
               </h2>
               <p class="text-sm text-gray-500 mt-1">
                  Veja o que quem comprou está dizendo
               </p>
            </div>

            <div class="shrink-0">
               <app-create-review-button
                  (addReviewClick)="openReviewModal()"
               ></app-create-review-button>
            </div>
         </div>

         <div class="min-h-[300px]">
            @if (reviewsState$ | async; as state) {
               @if (state.loading) {
                  <div class="py-20 flex justify-center">
                     <app-loading-spinner
                        [message]="'Carregando avaliações...'"
                     ></app-loading-spinner>
                  </div>
               }

               @if (state.error) {
                  <div class="py-12 px-6">
                     <app-error-container
                        [errorMessage]="
                           'Não foi possível carregar as avaliações.'
                        "
                     ></app-error-container>
                  </div>
               } @else {
                  @if (
                     state.reviews.data.length > 0 && state.reviews.data;
                     as reviews
                  ) {
                     <div class="flex flex-col">
                        <div
                           class="bg-gray-50/50 px-6 py-4 flex flex-col sm:flex-row justify-between items-center gap-4 border-b border-gray-100"
                        >
                           <span
                              class="text-sm font-semibold text-gray-600 bg-white px-3 py-1 rounded-full border border-gray-200 shadow-sm"
                           >
                              {{ state.reviews.pagination.totalElements }}
                              {{
                                 state.reviews.pagination.totalElements === 1
                                    ? "Avaliação"
                                    : "Avaliações"
                              }}
                           </span>

                           <div class="flex items-center gap-3 text-sm">
                              <label
                                 for="sort-reviews"
                                 class="text-gray-500 font-medium"
                                 >Ordenar:</label
                              >
                              <div class="relative">
                                 <select
                                    id="sort-reviews"
                                    (change)="onSortChange($event)"
                                    class="appearance-none bg-white border border-gray-300 text-gray-700 py-1.5 pl-3 pr-8 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-base/20 focus:border-orange-base cursor-pointer hover:border-gray-400 transition-colors text-sm font-medium"
                                 >
                                    @for (
                                       option of sortOptions;
                                       track option.value
                                    ) {
                                       <option [value]="option.value">
                                          {{ option.label }}
                                       </option>
                                    }
                                 </select>
                                 <div
                                    class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"
                                 >
                                    <svg
                                       class="h-4 w-4"
                                       fill="none"
                                       viewBox="0 0 24 24"
                                       stroke="currentColor"
                                    >
                                       <path
                                          stroke-linecap="round"
                                          stroke-linejoin="round"
                                          stroke-width="2"
                                          d="M19 9l-7 7-7-7"
                                       />
                                    </svg>
                                 </div>
                              </div>
                           </div>
                        </div>

                        <div class="p-6 space-y-6">
                           @for (review of reviews; track review.reviewId) {
                              <div
                                 class="border-b border-gray-100 last:border-0 pb-6 last:pb-0 animate-fade-in-up"
                              >
                                 <app-review-card
                                    [review]="review"
                                    (like)="handleLike($event)"
                                    (dislike)="handleDislike($event)"
                                    [commentState]="
                                       commentsMap.get(review.reviewId)
                                    "
                                    (loadComments)="loadComments($event)"
                                    (showLessComments)="
                                       handleShowLessComments($event)
                                    "
                                    (toggleComments)="
                                       handleToggleComments($event)
                                    "
                                    (submitReply)="handleSubmittedReply($event)"
                                    (delete)="handleDeleteRequest($event)"
                                    (commentDelete)="
                                       handleCommentDeleteRequest($event)
                                    "
                                    (commentLike)="handleCommentLike($event)"
                                    (commentDislike)="
                                       handleCommentDislike($event)
                                    "
                                    (edit)="handleReviewEdit()"
                                 ></app-review-card>
                              </div>
                           }
                        </div>

                        @if (state.reviews.pagination.totalPages > 1) {
                           <div
                              class="flex justify-center items-center gap-2 py-8 border-t border-gray-100 bg-gray-50/30"
                           >
                              <button
                                 (click)="
                                    onPageChange(
                                       state.reviews.pagination.page - 1
                                    )
                                 "
                                 [disabled]="
                                    state.reviews.pagination.page === 0
                                 "
                                 class="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-600 hover:bg-orange-base hover:text-white hover:border-orange-base disabled:opacity-30 disabled:hover:bg-white disabled:hover:text-gray-600 disabled:cursor-not-allowed transition-all shadow-sm"
                                 title="Anterior"
                              >
                                 <svg
                                    class="w-5 h-5"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                 >
                                    <path
                                       stroke-linecap="round"
                                       stroke-linejoin="round"
                                       stroke-width="2"
                                       d="M15 19l-7-7 7-7"
                                    ></path>
                                 </svg>
                              </button>

                              <div class="flex gap-1">
                                 @for (
                                    page of getPageNumbers(
                                       state.reviews.pagination.page,
                                       state.reviews.pagination.totalPages
                                    );
                                    track page
                                 ) {
                                    <button
                                       (click)="onPageChange(page)"
                                       [class.bg-orange-base]="
                                          page === state.reviews.pagination.page
                                       "
                                       [class.text-white]="
                                          page === state.reviews.pagination.page
                                       "
                                       [class.border-orange-base]="
                                          page === state.reviews.pagination.page
                                       "
                                       [class.bg-white]="
                                          page !== state.reviews.pagination.page
                                       "
                                       [class.text-gray-700]="
                                          page !== state.reviews.pagination.page
                                       "
                                       class="w-10 h-10 rounded-full border border-gray-200 text-sm font-medium hover:border-orange-base hover:text-orange-base transition-all shadow-sm flex items-center justify-center"
                                    >
                                       {{ page + 1 }}
                                    </button>
                                 }
                              </div>

                              <button
                                 (click)="
                                    onPageChange(
                                       state.reviews.pagination.page + 1
                                    )
                                 "
                                 [disabled]="
                                    state.reviews.pagination.page >=
                                    state.reviews.pagination.totalPages - 1
                                 "
                                 class="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-600 hover:bg-orange-base hover:text-white hover:border-orange-base disabled:opacity-30 disabled:hover:bg-white disabled:hover:text-gray-600 disabled:cursor-not-allowed transition-all shadow-sm"
                                 title="Próxima"
                              >
                                 <svg
                                    class="w-5 h-5"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                 >
                                    <path
                                       stroke-linecap="round"
                                       stroke-linejoin="round"
                                       stroke-width="2"
                                       d="M9 5l7 7-7 7"
                                    ></path>
                                 </svg>
                              </button>
                           </div>
                        }
                     </div>
                  } @else {
                     <div
                        class="text-center py-20 px-6 flex flex-col items-center justify-center animate-fade-in"
                     >
                        <div class="bg-gray-50 p-6 rounded-full mb-4">
                           <img
                              ngSrc="assets/icons/star-outline.svg"
                              alt="Nenhuma avaliação"
                              width="48"
                              height="48"
                              class="opacity-40 grayscale"
                           />
                        </div>
                        <h3 class="text-md font-bold text-gray-800 mb-2">
                           Ainda não há avaliações
                        </h3>
                        <p class="text-gray-500 max-w-md mx-auto text-sm">
                           Sua opinião é muito importante! Seja o primeiro a
                           compartilhar sua experiência com este produto.
                        </p>
                        <div class="mt-8">
                           <button
                              (click)="openReviewModal()"
                              class="text-orange-base font-semibold hover:underline"
                           >
                              Escrever uma avaliação agora
                           </button>
                        </div>
                     </div>
                  }
               }
            }
         </div>
      </div>
   </div>
</section>

@if (isModalOpen) {
   <app-create-review-modal
      (modalClose)="closeReviewModal()"
      (submitReview)="handleSubmitReview($event)"
   ></app-create-review-modal>
}

@if (isDeleteModalOpen) {
   <app-alert-modal
      [title]="'Confirmar Exclusão'"
      [message]="
         itemToDelete?.type === 'comment'
            ? 'Você tem certeza que deseja excluir este comentário?'
            : 'Você tem certeza que deseja excluir esta avaliação?'
      "
      [confirmButtonText]="'Excluir'"
      (alertClose)="closeDeleteModal()"
      (confirm)="confirmDelete()"
   ></app-alert-modal>
}
