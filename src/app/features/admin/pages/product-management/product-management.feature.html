<div class="container mx-auto lg:p-8 max-w-6xl">
   <div
      class="flex flex-col md:flex-row justify-between items-center mb-6 pb-2 border-b-2 border-orange-base gap-4"
   >
      <h1 class="text-lg lg:text-2xl font-bold text-gray-800">
         Gerenciamento de Produtos
      </h1>

      <button
         (click)="toggleForm()"
         class="flex items-center gap-2 px-5 py-2.5 rounded-lg font-semibold text-sm transition-all shadow-sm"
         [ngClass]="
            isFormVisible
               ? 'bg-gray-100 text-gray-700 hover:bg-gray-200'
               : 'bg-blue-base text-white hover:bg-blue-dark'
         "
      >
         @if (isFormVisible) {
            <svg
               xmlns="http://www.w3.org/2000/svg"
               fill="none"
               viewBox="0 0 24 24"
               stroke-width="2"
               stroke="currentColor"
               class="w-5 h-5"
            >
               <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M6 18L18 6M6 6l12 12"
               />
            </svg>
            <span>Fechar Formulário</span>
         } @else {
            <svg
               xmlns="http://www.w3.org/2000/svg"
               fill="none"
               viewBox="0 0 24 24"
               stroke-width="2"
               stroke="currentColor"
               class="w-5 h-5"
            >
               <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 4.5v15m7.5-7.5h-15"
               />
            </svg>
            <span>Novo Produto</span>
         }
      </button>
   </div>

   @if (isFormVisible) {
      <div class="animate-fade-in origin-top mb-10">
         <form
            [formGroup]="productForm"
            (ngSubmit)="onSubmit()"
            class="bg-white shadow-md rounded-lg p-3 lg:p-6 border border-gray-100"
         >
            <h2
               class="text-base lg:text-xl font-bold mb-4 text-primary flex items-center gap-2"
            >
               @if (editMode) {
                  <svg
                     xmlns="http://www.w3.org/2000/svg"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke-width="1.5"
                     stroke="currentColor"
                     class="w-6 h-6 text-orange-base"
                  >
                     <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"
                     />
                  </svg>
                  Editar Produto
               } @else {
                  <svg
                     xmlns="http://www.w3.org/2000/svg"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke-width="1.5"
                     stroke="currentColor"
                     class="w-6 h-6 text-green-600"
                  >
                     <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
                     />
                  </svg>
                  Novo Produto
               }
            </h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
               <div class="space-y-3 lg:space-y-4">
                  <div>
                     <label
                        for="prod-name"
                        class="block text-xs md:text-sm font-medium text-gray-700 mb-1"
                        >Nome</label
                     >
                     <input
                        id="prod-name"
                        type="text"
                        formControlName="name"
                        placeholder="Ex: Smartphone Samsung Galaxy"
                        class="w-full px-3 py-1.5 md:py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-base focus:border-blue-base placeholder-gray-400"
                     />
                  </div>
                  <div>
                     <label
                        for="prod-cat"
                        class="block text-xs md:text-sm font-medium text-gray-700 mb-1"
                        >Categoria</label
                     >
                     <select
                        id="prod-cat"
                        formControlName="categoryName"
                        class="w-full px-3 py-1.5 md:py-2 text-sm border border-gray-300 rounded-md bg-white focus:ring-blue-base focus:border-blue-base text-gray-700"
                     >
                        <option value="" disabled selected>
                           Selecione uma categoria
                        </option>
                        @for (cat of categories$ | async; track cat.id) {
                           <option [value]="cat.name">{{ cat.name }}</option>
                        }
                     </select>
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                     <div>
                        <label
                           for="prod-price"
                           class="block text-xs md:text-sm font-medium text-gray-700 mb-1"
                           >Preço (R$)</label
                        >
                        <input
                           id="prod-price"
                           type="number"
                           formControlName="price"
                           placeholder="0.00"
                           class="w-full px-3 py-1.5 md:py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-base focus:border-blue-base placeholder-gray-400"
                        />
                     </div>
                     <div>
                        <label
                           for="prod-stock"
                           class="block text-xs md:text-sm font-medium text-gray-700 mb-1"
                           >Estoque</label
                        >
                        <input
                           id="prod-stock"
                           type="number"
                           formControlName="stock"
                           placeholder="0"
                           class="w-full px-3 py-1.5 md:py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-base focus:border-blue-base placeholder-gray-400"
                        />
                     </div>
                  </div>
                  <div>
                     <label
                        for="prod-desc"
                        class="block text-xs md:text-sm font-medium text-gray-700 mb-1"
                        >Descrição</label
                     >
                     <textarea
                        id="prod-desc"
                        formControlName="description"
                        rows="5"
                        placeholder="Descreva as características principais do produto..."
                        class="w-full px-3 py-1.5 md:py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-base focus:border-blue-base placeholder-gray-400 resize-none"
                     ></textarea>
                  </div>
               </div>

               <div class="space-y-4 lg:space-y-6">
                  <div>
                     <span
                        class="block text-xs md:text-sm font-medium text-gray-700 mb-1"
                        >Imagem de Capa</span
                     >
                     <label
                        for="cover-upload"
                        (dragover)="onCoverDragOver($event)"
                        (dragleave)="onCoverDragLeave($event)"
                        (drop)="onCoverDrop($event)"
                        [class.border-blue-500]="isDraggingCover"
                        [class.bg-blue-50]="isDraggingCover"
                        [class.border-gray-300]="!isDraggingCover"
                        class="mt-1 flex justify-center px-4 pt-4 pb-4 border-2 border-dashed rounded-md cursor-pointer hover:bg-gray-50 transition-colors relative overflow-hidden group h-40 md:h-48 items-center"
                     >
                        <div
                           class="space-y-1 text-center w-full h-full flex flex-col justify-center pointer-events-none"
                        >
                           @if (coverPreview) {
                              <div
                                 class="relative w-full h-full flex items-center justify-center"
                              >
                                 <img
                                    [src]="coverPreview"
                                    alt="Capa Preview"
                                    class="w-full h-full object-contain rounded-md"
                                 />
                                 <div
                                    class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-md"
                                 >
                                    <p
                                       class="text-white font-bold border border-white px-3 py-1 rounded hover:bg-white hover:text-black transition-colors shadow-lg text-xs md:text-sm pointer-events-auto"
                                    >
                                       Alterar Capa
                                    </p>
                                 </div>
                              </div>
                              @if (selectedCoverFile) {
                                 <div
                                    class="absolute bottom-1 left-0 right-0 bg-white bg-opacity-75 py-0.5 px-2 mx-2 rounded shadow-sm"
                                 >
                                    <p
                                       class="text-[10px] md:text-xs font-medium text-green-700 truncate"
                                    >
                                       {{ selectedCoverFile.name }}
                                    </p>
                                 </div>
                              }
                           } @else {
                              <img
                                 src="assets/icons/upload.svg"
                                 alt=""
                                 class="mx-auto h-8 w-8 md:h-10 md:w-10 text-gray-400"
                              />
                              <div
                                 class="flex text-xs md:text-sm text-gray-600 justify-center mt-2"
                              >
                                 <span
                                    class="relative bg-white rounded-md font-medium text-blue-base hover:text-blue-dark focus-within:outline-none"
                                    ><span>Carregar capa</span></span
                                 >
                                 <p class="pl-1 hidden md:block">ou arraste</p>
                              </div>
                              <p
                                 class="text-[10px] md:text-xs text-gray-500 mt-1"
                              >
                                 PNG, JPG, WEBP até 10MB
                              </p>
                           }
                           <input
                              id="cover-upload"
                              #coverInput
                              (change)="onCoverChange($event)"
                              type="file"
                              class="sr-only"
                              accept="image/png, image/jpeg, image/webp"
                           />
                        </div>
                     </label>
                  </div>

                  <div>
                     <span
                        class="block text-xs md:text-sm font-medium text-gray-700 mb-2"
                        >Galeria de Imagens</span
                     >
                     <label
                        for="others-upload"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-gray-50 border border-gray-300 rounded-md cursor-pointer hover:bg-gray-100 transition-colors mb-3"
                     >
                        <svg
                           xmlns="http://www.w3.org/2000/svg"
                           fill="none"
                           viewBox="0 0 24 24"
                           stroke-width="1.5"
                           stroke="currentColor"
                           class="w-4 h-4 text-gray-600"
                        >
                           <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              d="M12 4.5v15m7.5-7.5h-15"
                           />
                        </svg>
                        <span
                           class="text-xs md:text-sm font-medium text-gray-700"
                           >Adicionar Imagens</span
                        >
                        <input
                           id="others-upload"
                           #othersInput
                           type="file"
                           multiple
                           (change)="onOthersChange($event)"
                           accept="image/png, image/jpeg, image/webp"
                           class="sr-only"
                        />
                     </label>
                     <div class="grid grid-cols-4 sm:grid-cols-5 gap-2">
                        @for (img of existingImages; track img.publicId) {
                           <div
                              class="relative aspect-square border border-blue-200 rounded-md overflow-hidden group bg-gray-50"
                           >
                              <img
                                 [src]="img.url"
                                 class="w-full h-full object-cover"
                                 alt="Product image"
                              />
                              <button
                                 type="button"
                                 (click)="removeExistingImage(img.publicId)"
                                 class="absolute top-0 right-0 bg-red-500 text-white p-1 rounded-bl opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600"
                                 title="Remover"
                              >
                                 <svg
                                    class="w-3 h-3"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                 >
                                    <path
                                       stroke-linecap="round"
                                       stroke-linejoin="round"
                                       stroke-width="2"
                                       d="M6 18L18 6M6 6l12 12"
                                    ></path>
                                 </svg>
                              </button>
                           </div>
                        }
                        @for (preview of otherPreviews; track $index) {
                           <div
                              class="relative aspect-square border border-green-200 rounded-md overflow-hidden group bg-gray-50"
                           >
                              <img
                                 [src]="preview"
                                 class="w-full h-full object-cover"
                                 alt="Product image"
                              />
                              <button
                                 type="button"
                                 (click)="removeNewOtherImage($index)"
                                 class="absolute top-0 right-0 bg-red-500 text-white p-1 rounded-bl opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600"
                                 title="Remover"
                              >
                                 <svg
                                    class="w-3 h-3"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                 >
                                    <path
                                       stroke-linecap="round"
                                       stroke-linejoin="round"
                                       stroke-width="2"
                                       d="M6 18L18 6M6 6l12 12"
                                    ></path>
                                 </svg>
                              </button>
                              <div
                                 class="absolute bottom-0 left-0 right-0 bg-green-500 h-1"
                              ></div>
                           </div>
                        }
                     </div>
                     @if (
                        existingImages.length === 0 &&
                        otherPreviews.length === 0
                     ) {
                        <p class="text-xs text-gray-400 italic mt-2">
                           Nenhuma imagem na galeria.
                        </p>
                     }
                  </div>
               </div>
            </div>

            <div
               class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-100"
            >
               <button
                  type="button"
                  (click)="resetForm()"
                  class="py-1.5 px-4 border border-gray-300 rounded-md shadow-sm text-xs md:text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors"
               >
                  Cancelar
               </button>
               <button
                  type="submit"
                  [disabled]="
                     productForm.invalid ||
                     (!editMode && !selectedCoverFile) ||
                     isSubmitting
                  "
                  class="py-1.5 px-4 min-w-[100px] flex justify-center items-center border border-transparent rounded-md shadow-sm text-xs md:text-sm font-medium text-white bg-blue-base hover:bg-blue-dark disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
               >
                  @if (isSubmitting) {
                     <svg
                        class="animate-spin h-4 w-4 text-white"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                     >
                        <circle
                           class="opacity-25"
                           cx="12"
                           cy="12"
                           r="10"
                           stroke="currentColor"
                           stroke-width="4"
                        ></circle>
                        <path
                           class="opacity-75"
                           fill="currentColor"
                           d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                        ></path>
                     </svg>
                  } @else {
                     <span>{{ editMode ? "Salvar" : "Criar" }}</span>
                  }
               </button>
            </div>
         </form>
      </div>
   }

   @if (productsState$ | async; as state) {
      <div class="mb-6 sticky top-0 z-20">
         <app-filter-bar
            placeholder="Buscar produtos na tabela..."
            (filterChange)="onFilterChange($event)"
         >
         </app-filter-bar>
      </div>

      @if (state.loading) {
         <app-loading-spinner></app-loading-spinner>
      } @else {
         <app-product-table
            [products]="state.products.data"
            (edit)="onEdit($event)"
            (delete)="onDelete($event!)"
         ></app-product-table>
      }

      @if (state.products.pagination.totalPages > 1) {
         <div
            class="flex flex-col sm:flex-row justify-between items-center mt-4 gap-3"
         >
            <span class="text-xs text-gray-700 text-center sm:text-left">
               Página
               <span class="font-bold">{{
                  state.products.pagination.page + 1
               }}</span>
               de
               <span class="font-bold">{{
                  state.products.pagination.totalPages
               }}</span>
               (Total: {{ state.products.pagination.totalElements }})
            </span>

            <div class="inline-flex gap-2">
               <button
                  (click)="prevPage(state.products.pagination.page)"
                  [disabled]="state.products.pagination.page === 0"
                  class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
               >
                  Anterior
               </button>
               <button
                  (click)="
                     nextPage(
                        state.products.pagination.page,
                        state.products.pagination.totalPages
                     )
                  "
                  [disabled]="
                     state.products.pagination.page >=
                     state.products.pagination.totalPages - 1
                  "
                  class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
               >
                  Próxima
               </button>
            </div>
         </div>
      }
   }
</div>

@if (isDeleteModalOpen) {
   <app-alert-modal
      title="Excluir Produto"
      [message]="
         'Tem certeza que deseja excluir este produto? Esta ação não pode ser desfeita.'
      "
      confirmButtonText="Sim, excluir"
      cancelButtonText="Cancelar"
      (confirm)="confirmDelete()"
      (alertClose)="closeDeleteModal()"
   ></app-alert-modal>
}
